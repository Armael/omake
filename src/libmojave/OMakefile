#
# Link all the files from the external reference to libmojave.
#
EXTERNAL = ../libmojave-external

STDLIB_FILES[] =
    lm_thread_core.mli
    lm_thread_pool.mli


# UNIX_FILES[] =
    # lm_uname.ml
    # lm_unix_util.ml
    # lm_uname.mli
    # lm_unix_util.mli
    # lm_notify.ml
    # lm_notify.mli
    # lm_fs_case_sensitive.ml
    # lm_fs_case_sensitive.mli

EXTERNAL_FILES[] =
    $(STDLIB_FILES)
    # $(UNIX_FILES)
    lm_symbol.ml
    lm_symbol.mli

MakeLinkExternal($(EXTERNAL)/stdlib, $(STDLIB_FILES))
# MakeLinkExternal($(EXTERNAL)/unix, $(UNIX_FILES))
MakeLinkExternalFile(lm_symbol.ml, $(EXTERNAL)/util/lm_symbol_hash.ml)
MakeLinkExternalFile(lm_symbol.mli, $(EXTERNAL)/util/lm_symbol_hash.mli)

OCamlGeneratedFiles($(EXTERNAL_FILES))

########################################################################
# These are all the files we care about
#
FILES[] =
    lm_printf
    lm_debug
    lm_heap
    lm_list_util
    lm_array_util
    lm_set_sig
    lm_set
    lm_map_sig
    lm_map
    lm_int_set
    lm_termsize
    lm_terminfo
    lm_arg
    lm_index
    lm_thread_sig
    lm_thread_core
    lm_thread
    lm_string_util
    lm_string_set
    lm_hash_sig
    lm_hash
    lm_symbol
    lm_location
    lm_position
    lm_filename_util
    lm_uname
    lm_thread_pool
    lm_channel
    lm_lexer
    lm_parser
    lm_unix_util
    lm_glob
    lm_db
    lm_notify
    lm_fs_case_sensitive

#
# Generated filed
#
GENERATED_FILES[] =
    lm_thread_pool.ml
    lm_thread_core.ml

if $(THREADS_ENABLED)
    OMAKE_THREAD_POOL = $(EXTERNAL)/stdlib/lm_thread_pool_system.ml
    OMAKE_THREAD_CORE = $(EXTERNAL)/stdlib/lm_thread_core_system.ml
    export
else
    OMAKE_THREAD_POOL = $(EXTERNAL)/stdlib/lm_thread_pool_null.ml
    OMAKE_THREAD_CORE = $(EXTERNAL)/stdlib/lm_thread_core_null.ml
    export

lm_thread_pool.ml: $(OMAKE_THREAD_POOL)
    ln-or-cp $< $@

lm_thread_core.ml: $(OMAKE_THREAD_CORE)
    ln-or-cp $< $@

OCamlGeneratedFiles($(GENERATED_FILES))

#
# Build the library
#
MakeOCamlLibrary(lm, $(FILES))

#
# Cleanup
#
clean:
    $(CLEAN) $(EXTERNAL_FILES) $(GENERATED_FILES)

#
# Generate a Makefile
#
MakeLinkFile(lm_thread_pool.ml, $(EXTERNAL)/stdlib/lm_thread_pool_$'$(system)'.ml)
MakeLinkFile(lm_thread_core.ml, $(EXTERNAL)/stdlib/lm_thread_core_$'$(system)'.ml)
MakeMakefile()
